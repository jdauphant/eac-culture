<!DOCTYPE html>
<html>
<head>
    <title>Evenement EAC</title>
    
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css?family=Nunito" rel="stylesheet">    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://rawgit.com/Leaflet/Leaflet.markercluster/v1.2.0/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://rawgit.com/Leaflet/Leaflet.markercluster/v1.2.0/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://cdn.rawgit.com/Pixabay/JavaScript-autoComplete/1.0.4/auto-complete.css" />
    <link rel="stylesheet" href="https://opensource.keycdn.com/fontawesome/4.7.0/font-awesome.min.css" integrity="sha384-dNpIIXE8U05kAbPhy3G1cz+yZmTzA6CY8Vg/u2L9xRnHjJiAK76m2BIEaSEV+/aU" crossorigin="anonymous">
    <link rel="stylesheet" href="index.css" />
    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"></script>
    <script src="https://rawgit.com/Leaflet/Leaflet.markercluster/v1.2.0/dist/leaflet.markercluster.js"></script>
    <script src="https://cdn.rawgit.com/Pixabay/JavaScript-autoComplete/1.0.4/auto-complete.min.js"></script>
    <script src="js/csv.js"></script>
    <style type="text/css">
        html, body { 
            height: 100%; 
            margin: 0; 
            padding: 0;
        }
        #map {
            height: 100%;
            display: block;
        }
        .address {
            width: 300px;
            position: absolute;
            padding: 5px;
            top: 10px;
            left: 55px;
        }
    </style>
    
</head>

<body>
    <div class="header">
        <div class="header__image">
        </div>
        <div class="header__avatar">
        </div>
        
        <div class="header__favorites">
        </div>
    </div>
    <div class="filter">

    </div>
    <div class="main">
        <div class="galery galery--force-scrollbar" id="galery">
            <div class="galery__card galery__card--clickable">
                <div class="galery__card__image" style="background-image: url('images/icons/music-conductor-filled-50.png')"></div>
                <div class="galery__card__favorite"></div>
                <h2 class="galery__card__title">Orchestre national d'Île-de-France</h2>
                <p class="galery__card__description">Formation symphonique de notoriété internationale, l'Orchestre national d'Île-de-France propose une centaine de concerts par an. Sa mission : la diffusion du répertoire symphonique en Île-de-France.
                </p>
                <div class="galery__card__bottom">
                    12 projets EAC avec 3 établissements scolaires
                </div>
            </div>  
        </div>
        <div id="map">
        </div>
    </div>
    <script>
        var center = {lat: 46.57886370185589, lng: 0.3578281402587891};
        
        // Map
        var map = L.map('map', {
            drawControl: true,
            center: center,
            zoom: 15,
            minZoom: 3
        });
        
        L.tileLayer(
        'http://{s}.tile.openstreetmap.fr/openriverboatmap/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="http://openstreetmap.org">OpenStreetMap</a> Contributors & <a href="http://openstreetmap.fr/">OSM FR</a>',
            maxZoom: 18,
        }).addTo(map);


        var projectEAC = [];
        var links = [];

        var linksLayerGroup = L.layerGroup();
        linksLayerGroup.addTo(map);
        var linksSelectedSchoolLayerGroup = L.layerGroup();
        linksSelectedSchoolLayerGroup.addTo(map);
        var cultureLayerGroup = L.layerGroup();
        cultureLayerGroup.addTo(map);
        var schoolLayerGroup = L.layerGroup();
        schoolLayerGroup.addTo(map);

        function refreshIconsSize() {
            changeSizeLayerGroup(cultureLayerGroup);
            changeSizeLayerGroup(schoolLayerGroup);
        }
        function changeSizeLayerGroup(layerGroup) {
            var currentZoom = map.getZoom();
            layerGroup.eachLayer(function(marker){
                var icon = marker._icon
                if (currentZoom < 14 ) {
                    icon.style.width="25px";
                    icon.style.height="25px";
                    icon.classList.add("icon__label--small");
                } else {
                    icon.style.width="50px";
                    icon.style.height="50px";
                    icon.classList.remove("icon__label--small");
                }
            })
        }

        map.on('zoomend', function() {
            refreshIconsSize();
        });

        function showLinksSchool(schoolUAI) {
            return function() {
                cleanLink();
                var linksToShow = links.filter(
                    element => element.school == schoolUAI
                )
                showLinks(linksToShow, "#53205D");
            }
        }

        function showLinksCulture(culture) {
            return function() {
                cleanLink();
                var linksToShow = links.filter(
                    element => element.culture == culture
                )
                showLinks(linksToShow, "#0081CB");
            }
        }

        function showLinks(linksToShow, color) {
            linksToShow.forEach(function(element) {
                    var school = searchEtablissement(element.school);
                    var culturalActor = searchActeurCulturels(element.culture);
                    if(school != undefined && culturalActor != undefined)  {
                        var coord1 = { lat: school[11], lng: school[12]};
                        if(culturalActor[5] != undefined && culturalActor[6] != undefined && culturalActor[5] != 0 && culturalActor[6] != 0) {
                            var coord2 = { lat: culturalActor[5], lng: culturalActor[6]};
                            var polyline = L.polyline([coord1, coord2], {
                                color: color,
                                weight: 5,
                                opacity: 1,
                            })
                            linksLayerGroup.addLayer(polyline);
                        }
                        
                    }
                });
        }

        function cleanLink() {
            linksLayerGroup.clearLayers();
        }
        
   
        function showSelectedSchoolLink() {
            linksSelectedSchoolLayerGroup.clearLayers();
            links.forEach(function(element) {
                    var school = searchEtablissement(element.school);
                    var culturalActor = searchActeurCulturels(element.culture);
                    if(school != undefined && culturalActor != undefined && school[0] === selectedSchool[0])  {
                        var coord1 = { lat: school[11], lng: school[12]};
                        if(culturalActor[5] != undefined && culturalActor[6] != undefined && culturalActor[5] != 0 && culturalActor[6] != 0) {
                            var coord2 = { lat: culturalActor[5], lng: culturalActor[6]};
                            var polyline = L.polyline([coord1, coord2], {
                                color: 'blue',
                                weight: 5,
                                opacity: 0.1,
                            })
                            linksSelectedSchoolLayerGroup.addLayer(polyline);
                        }
                        
                    }
                });
        }

        var etablissementsRequest = {};
        
        var etablissements = [];

        function showSchools() {
            etablissements.forEach(function(element) {
                    var lat = Number(element[11]);
                    var lon = Number(element[12]);
                    if(lat != 0 && lon != 0) {
                        var latLng = { lat: lat, lng: lon};
                        var icon;
                        if(element[0] === selectedSchool[0]) {
                            icon = L.divIcon({
                                html: "C", 
                                className: 'icon__label icon__label--selected-college',
                                iconSize: [50,50]
                            });
                            map.flyTo(latLng);
                        } else {
                            icon = L.divIcon({
                                html: "C", 
                                className: 'icon__label icon__label--college',
                                iconSize: [50,50]
                            });
                        }
                        var marker = L.marker(latLng, {icon: icon});
                        marker.bindPopup("<b>"+element[1]+"</b>",
                        {  closeButton: false });
                        marker.on('mouseover', function (e) {
                            this.openPopup();
                        });
                        marker.on('mouseout', function (e) {
                            this.closePopup();
                        });

                        marker.on("mouseover", showLinksSchool(element[0]));
                        marker.on("mouseout", cleanLink);
                        marker.on("click", function (e) {
                            schoolLayerGroup.clearLayers();
                            selectedSchool = element;
                            showSchools();
                            showSelectedSchoolLink();
                        });
                        schoolLayerGroup.addLayer(marker);
                    }
                });
        }
        var selectedSchool;
        // Etablissements
        var etablissementsRequestRequest = new XMLHttpRequest();
        etablissementsRequestRequest.open('GET', 'data-colleges-vienne/Etablissements-Grid view.csv', true); 
        etablissementsRequestRequest.onload = function() {
            if (etablissementsRequestRequest.status >= 200 && etablissementsRequestRequest.status < 400) {
                
                // Success!
                var data = CSVToArray(etablissementsRequestRequest.responseText, ",");
                etablissements = Array.from(data);
                etablissements.shift();
                selectedSchool = etablissements.filter(school => school[0] === "0861071X")[0];
                acteursCulturelsRequestRequest.send();
                
                showSchools();
            } else {
            }
        };
        
        etablissementsRequestRequest.send();
        
        // ActeursCulturelles
        var acteursCulturels = [];
        var acteursCulturelsRequestRequest = new XMLHttpRequest();
        acteursCulturelsRequestRequest.open('GET', 'data-colleges-vienne/Acteurs Culturels-Grid view.csv', true); 
        acteursCulturelsRequestRequest.onload = function() {
            if (acteursCulturelsRequestRequest.status >= 200 && acteursCulturelsRequestRequest.status < 400) {
                
                // Success!
                var data = CSVToArray(acteursCulturelsRequestRequest.responseText, ",");
                acteursCulturels = Array.from(data);
                acteursCulturels.shift();
                projetEACRequest.send();
                showActeurCulturel(acteursCulturels);
                
                acteursCulturels.forEach(function(element) {
                    var lat = Number(element[5]);
                    var lon = Number(element[6]);
                    if(lat != 0 && lon != 0) {
                        var icon;
                        if(element[2] === "Théâtre" ) {
                            icon = L.divIcon({
                                html: "<img src='images/icons/theatre-mask-filled-50.png' style='width: 50%; margin: 25%;'>", 
                                className: 'icon__label icon__label--blue',
                                iconSize: [50,50]
                            });
                        } else if(element[2] == "Cinéma" ) {
                            icon = L.divIcon({
                                html: "<img src='images/icons/movie-filled-50.png' style='width: 50%; margin:25%;'>", 
                                className: 'icon__label icon__label--blue',
                                iconSize: [50,50]
                            });
                        } else if(element[2] != "Musée") {
                            icon = L.divIcon({
                                html: "<img src='images/icons/museum-filled-50.png' style='width: 50%; margin:25%;'>", 
                                className: 'icon__label icon__label--blue',
                                iconSize: [50,50]
                            });
                        } else if(element[2] != "Bibliothèque/Médiathèque") {
                            icon = L.divIcon({
                                html: "<img src='images/icons/library-filled-50.png' style='width: 50%; margin:25%;'>", 
                                className: 'icon__label icon__label--blue',
                                iconSize: [50,50]
                            });
                        } else if(element[2] != "Musique/Orchestre") {
                            icon = L.divIcon({
                                html: "<img src='images/icons/music-filled-50.png' style='width: 50%; margin:25%;'>", 
                                className: 'icon__label icon__label--blue',
                                iconSize: [50,50]
                            });
                        } else {
                            icon = L.divIcon({
                                html: "A", 
                                className: 'icon__label icon__label--orange',
                                iconSize: [50,50]
                            });
                        }
                        var marker = L.marker({ lat: lat, lng: lon}, {icon: icon});
                        marker.bindPopup("<b>"+element[0]+"</b>",
                        {  closeButton: false });
                        marker.on('mouseover', function (e) {
                            this.openPopup();
                        });
                        marker.on('mouseout', function (e) {
                            this.closePopup();
                        });
                        marker.on("mouseover", showLinksCulture(element[0]));
                        marker.on("mouseout", cleanLink);
                        cultureLayerGroup.addLayer(marker);
                    }
                });
                
            } else {
            }
        };
        
        function searchEtablissement(uai) {
            return etablissements.filter(function(element){
                return element[0] === uai;
            })[0];
        }
        
        function searchActeurCulturels(name) {
            return acteursCulturels.filter(function(element){
                return element[0] === name;
            })[0];
        }
     

        // Projects
        var projetEACRequest = new XMLHttpRequest();
        projetEACRequest.open('GET', 'data-colleges-vienne/Actions-Grid view.csv', true); 
        projetEACRequest.onload = function() {
            if (projetEACRequest.status >= 200 && projetEACRequest.status < 400) {
                
                // Success!
                var data = CSVToArray(projetEACRequest.responseText, ",");
                projetEAC = Array.from(data);
                projetEAC.shift();
                links = projetEAC.reduce(
                (acc, action) =>  { 
                    if(action[8] != "" && action[8] != undefined) {  
                        return acc.concat(action[8].split(',').map(e => { return { school: action[2], culture: e} }));
                    } else { 
                        return acc 
                    } 
                }, Array.from([]));
                
                showSelectedSchoolLink();
            } else {
            }
        };

        
        function showActeurCulturel(acteurs) {
			var card = document.getElementsByClassName("galery__card")[0];
			var newCards = acteurs.map(function (acteur) {
				var newCard = card.cloneNode(true);
                Array.from(newCard.children).forEach(function (child) {
                    if (child.className == "galery__card__image") {
                        var type = acteur[2].split(",")[0];
                        var icon = "museum";
                        if(type == "Théâtre") {
                            icon = "theatre-mask";
                        } else if(type == "Musique/Orchestre") {
                            icon = "music";
                        } else if(type == "Bibliothèque/Médiathèque") {
                            icon = "library";
                        } else if(type == "Cinéma") {
                            icon = "movie";
                        }
                        child.style["background-image"] = "url(images/icons/"+icon+"-filled-50.png)";
                    } else if(child.className == "galery__card__title") {
                        child.innerHTML = acteur[0];
                    } else if(child.className == "galery__card__description") {
                        child.innerHTML = acteur[1];
                    } else if(child.className == "galery__card__bottom") {
                        child.innerHTML = "25 projets EAC avec 15 écoles";
                    }
                });
                return newCard;
            });
            var galery = document.getElementById("galery");
            galery.removeChild(card);
			newCards.forEach(function (card) {
				galery.appendChild(card);
			});
        }
        
    </script>
</body>
</html>
